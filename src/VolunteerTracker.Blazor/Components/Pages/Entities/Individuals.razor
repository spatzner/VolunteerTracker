@page "/individuals"

@using VolunteerTracker.Blazor.Services
@using VolunteerTracker.Blazor.Components.Shared.Element;
@using VolunteerTracker.Blazor.Models
@using VolunteerTracker.Common

@inject IndividualDataProvider IndividualDataProvider

<h3>Individuals <VTButtonAddSimple ContainerClass="ms-2 mb-2 flex d-inline" @onclick="async () => await EditModal(null)"></VTButtonAddSimple></h3>

<Grid @ref="dataGrid"TItem="Individual"
      Class="table table-hover table-bordered table-striped"
      DataProvider="IndividualProvider"
      AllowFiltering="true"
      AllowPaging="true"
      Reload>
    <GridColumn TItem="Individual" HeaderText="Actions" Filterable="false" TextNoWrap="true">
        <VTButtonViewSimple ContainerClass="d-inline" OnClick="async () => await ViewModal(context.Id)"></VTButtonViewSimple>
        <VTButtonEditSimple ContainerClass="d-inline" OnClick="async () => await EditModal(context.Id)"></VTButtonEditSimple>
    </GridColumn>
    <GridColumn TItem="Individual" PropertyName="@nameof(Individual.FirstName)" HeaderText="First Name" FilterOperator="FilterOperator.StartsWith">
        <b>@context.FirstName</b>
    </GridColumn>    
    <GridColumn TItem="Individual" PropertyName="@nameof(Individual.LastName)" HeaderText="Last Name" FilterOperator="FilterOperator.StartsWith">
        <b>@context.LastName</b>
    </GridColumn>
    <GridColumn TItem="Individual" PropertyName="@nameof(Individual.Location)" HeaderText="Location" Filterable="false">
        @context.Location
    </GridColumn>
    <GridColumn TItem="Individual" PropertyName="@nameof(Individual.Phone)" HeaderText="Phone" FilterOperator="FilterOperator.StartsWith">
        @PhoneNumberFormatter.Format(context.Phone)
    </GridColumn>
    <GridColumn TItem="Individual" PropertyName="@nameof(Individual.Email)" HeaderText="Email" FilterOperator="FilterOperator.StartsWith">
        @context.Email
    </GridColumn>
</Grid>

<Modal @ref="_editModal" Size="ModalSize.ExtraLarge">
</Modal>

@code {

    [Inject]
    protected PreloadService PreloadService { get; set; } = null!;

    [Inject]
    public PhoneNumberFormatter PhoneNumberFormatter { get; set; } = null!;


    private Modal _editModal = null!;
    private Grid<Individual> dataGrid = null!;

    private async Task EditModal(Guid? id)
    {
        var onCloseCallback = new EventCallback(this, (Func<Task>)CloseModal);
        var parameters = new Dictionary<string, object> { { "PersonGuid", id! }, { "OnClose", onCloseCallback } }; await _editModal.ShowAsync<IndividualEdit>(title: "Individual Details", parameters: parameters);
    }

    private async Task ViewModal(Guid id)
    {
        var onCloseCallback = new EventCallback(this, (Func<Task>)CloseModal);
        var parameters = new Dictionary<string, object> { { "PersonGuid", id }, { "OnClose", onCloseCallback } };
        await _editModal.ShowAsync<IndividualView>(title: "Individual Details", parameters: parameters);
    }

    private async Task CloseModal()
    {
        await _editModal.HideAsync();
        await dataGrid.RefreshDataAsync();
    }

    private async Task<GridDataProviderResult<Individual>> IndividualProvider(GridDataProviderRequest<Individual> request)
    {
        var data = await IndividualDataProvider.Provide(request);
        return data;
    }

}